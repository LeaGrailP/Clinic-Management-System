import{c as d,o as c,a as t,t as l,B as z,r as P,C as M,A as T,e as we,k as ke,f as E,D as he,F as R,i as B,h as H,v as G,j as _e,b as J,w as Ne,q as Pe,E as Se,p as Ce}from"./D3CRd6su.js";import{c as Te}from"./BWhFkNBA.js";const Ae=Te("user-round-plus",[["path",{d:"M2 21a8 8 0 0 1 13.292-6",key:"bjp14o"}],["circle",{cx:"10",cy:"8",r:"5",key:"o932ke"}],["path",{d:"M19 16v6",key:"tddt3s"}],["path",{d:"M22 19h-6",key:"vcuq98"}]]);function b(g){return Math.round(Number(g||0)*100)/100}function Ee(g){let S=0,o=0,m=0,p=0,v=0;return{processed:g.map(x=>{const i=Number(x.quantity||0),r=Number(x.unitPrice??x.price??0),n=b(i*r);return S+=n,o+=Number(x.vatSales||0)*i,m+=Number(x.vatAmount||0)*i,p+=Number(x.vatExempt||0)*i,v+=Number(x.zeroRated||0)*i,{...x,total:n}}),subtotal:b(S),vatSales:b(o),vatAmount:b(m),vatExempt:b(p),zeroRated:b(v)}}function je(g,S,o,m){let p=0;if(!o)return 0;if(o==="SC"||o==="PWD")return p=b(S*.2),p;if(o==="PERCENT"){const v=Number(m||0);return p=b(g*(v/100)),p}return o==="AMOUNT"?b(Number(m||0)):0}function De(g,S,o,m){const{processed:p,subtotal:v,vatSales:C,vatAmount:x,vatExempt:i,zeroRated:r}=Ee(g);let n=je(v,C,S,o);n<0&&(n=0),n>v&&(n=v);const f=b(v-n),y=v>0?f/v:1,w=b(C*y),L=b(x*y),V=b(i*y),F=b(r*y),u=f,A=b((Number(m)||0)-u);return{items:p,subtotal:v,discountAmount:n,total:u,vatSales:w,vatAmount:L,vatExempt:V,zeroRated:F,change:A>=0?A:0}}const Ie={class:"relative"},qe=["type","readonly","value"],Re={class:"absolute left-3 -top-2 text-xs text-slate-800 bg-slate-50 px-1 transition-all peer-focus:-top-2 peer-focus:text-xs peer-placeholder-shown:top-2 peer-placeholder-shown:text-sm dark:text-slate-100 dark:bg-slate-800"},Le={__name:"BaseInput",props:{label:{type:String,required:!0},modelValue:{type:[String,Number],default:""},readonly:{type:Boolean,default:!1},type:{type:String,default:"text"}},emits:["update:modelValue"],setup(g,{emit:S}){return(o,m)=>(c(),d("div",Ie,[t("input",{type:g.type,readonly:g.readonly,value:g.modelValue,onInput:m[0]||(m[0]=p=>o.$emit("update:modelValue",p.target.value)),class:"peer block w-full rounded-lg border border-slate-400 bg-slate-50 text-slate-800 focus:outline-none focus:ring-0 dark:bg-slate-800 dark:border-slate-600 dark:text-slate-100"},null,40,qe),t("label",Re,l(g.label),1)]))}},Ve=globalThis.setInterval,$e={key:0,class:"w-full h-2 bg-slate-300 dark:bg-slate-700 rounded-b"},ze={class:"min-h-screen p-6 space-y-6 pb-32 bg-slate-50 dark:bg-slate-800 text-slate-800 dark:text-slate-100"},Me={class:"grid grid-cols-1 md:grid-cols-4 gap-4"},Be={class:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-220px)]"},Fe={class:"flex flex-col p-4 rounded-xl shadow bg-slate-100 dark:bg-slate-600 border-slate-200 dark:border-slate-700"},Ue={class:"flex-1 overflow-y-auto divide-y divide-slate-300 dark:divide-slate-700"},Oe=["onClick"],He={class:"flex flex-col"},We={class:"font-medium text-sm"},Qe={class:"flex flex-col p-4 rounded-xl shadow border bg-slate-100 dark:bg-slate-600 border-slate-200 dark:border-slate-700"},Ge={class:"flex-1 overflow-y-auto"},Je={class:"truncate"},Ze={class:"text-center"},Ke={class:"text-right"},Xe={class:"flex justify-center gap-1"},Ye=["onClick"],et=["onClick"],tt=["onClick"],st={class:"flex flex-col gap-4 h-full"},at={class:"p-4 rounded-xl shadow border bg-slate-100 dark:bg-slate-700 border-slate-300 dark:border-slate-600 space-y-3"},nt={class:"flex items-center justify-between"},rt={class:"relative"},lt={key:0,class:"absolute z-20 w-full mt-1 bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-600 rounded shadow-lg max-h-48 overflow-y-auto"},ot=["onClick"],it={class:"text-sm font-medium"},ut={class:"text-xs text-gray-500"},dt={class:"p-4 rounded-xl shadow border bg-slate-100 dark:bg-slate-700 border-slate-200 dark:border-slate-600 space-y-3"},ct={class:"flex justify-between items-center"},vt={key:0,class:"space-y-2 border-gray-400"},mt={class:"p-4 rounded-xl shadow border bg-slate-100 dark:bg-slate-700 border-slate-200 dark:border-slate-600 space-y-3"},pt={class:"flex justify-between items-center"},bt={class:"flex justify-between text-lg"},ft={class:"font-semibold"},yt={class:"p-4 rounded-xl shadow border flex justify-between items-center bg-sky-400 dark:bg-sky-800 border-slate-300 dark:border-slate-700"},gt={class:"text-2xl font-bold text-slate-900 dark:text-slate-100"},xt={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},wt={class:"p-4 rounded-lg shadow-lg w-[320px] max-h-[90vh] overflow-auto bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-slate-100"},kt={class:"flex mb-1 justify-between"},ht={class:"flex mb-1 justify-between"},_t={class:"flex mb-1 justify-between"},Nt={key:0,class:"flex mb-1 justify-between"},Pt={key:1,class:"flex mb-1 justify-between"},St={key:2,class:"flex justify-between mb-1"},Ct={class:"flex justify-between mb-1"},Tt={class:"flex justify-between mb-1"},At={class:"flex justify-between mb-1"},Et={class:"flex justify-between mb-1"},jt={class:"flex justify-between mb-1 font-bold"},Dt={class:"flex justify-between mb-1"},It={class:"flex justify-between mb-2 font-semibold"},qt={class:"flex justify-between mt-4"},Rt=["disabled"],$t={__name:"dashboard",setup(g,{expose:S}){const o=z({invoiceNumber:"",issuedBy:localStorage.getItem("name")||"Unknown User",invoiceDate:"",invoiceTime:""}),m=P(!1),p=P(""),v=P("");let C=null;const x=P([]),i=P([]),r=z({subtotal:0,vat_sales:0,vat_amount:0,vat_exempt_sales:0,zero_rated_sales:0,discount:0,total:0,_discountAmount:0}),n=z({type:"",amount:0,rate:0,raw:""}),f=z({name:"",tin:""}),y=z({active:!1,value:0}),w=P(0),L=P(null),V=P(!1);let F=null,u={},A=null;function U(s){return Math.round(Number(s||0)*100)/100}function k(s){return new Intl.NumberFormat("en-PH",{style:"currency",currency:"PHP"}).format(Number(s)||0)}function Z(){const s=new Date;o.invoiceDate=s.toISOString().split("T")[0],o.invoiceTime=s.toTimeString().slice(0,5)}M(p,s=>{C&&clearTimeout(C),C=setTimeout(()=>v.value=String(s||"").trim().toLowerCase(),250)});function j(s=600){return new Promise(e=>{y.active=!0,y.value=0;const N=performance.now();function a(h){const q=h-N,Y=Math.min(80,q/s*80);y.value=Y,Y<80?requestAnimationFrame(a):e()}requestAnimationFrame(a)})}async function D(){y.value=100,setTimeout(()=>{y.active=!1,y.value=0},150)}const ee={name:localStorage.getItem("name"),role:localStorage.getItem("role")};async function te(){if(ee.role!=="admin")return alert("âŒ Only admins can open the cash drawer.");try{await window.electron.invoke("open-cash-drawer"),alert("âœ… Cash drawer opened!")}catch(s){alert("Failed to open drawer: "+(s?.message||s))}}const O=P(""),I=P([]);M(O,s=>{A&&clearTimeout(A),A=setTimeout(()=>se(s),250)});async function se(s){if(!s){I.value=[];return}try{const e=await window.patientAPI.searchPatients(s);I.value=Array.isArray(e)?e:[]}catch(e){console.error("fetchPatientMatches:",e),I.value=[]}}function ae(s){f.name=`${s.firstName} ${s.middleName||""} ${s.lastName}`.trim(),f.tin=s.tin||"",O.value=f.name,I.value=[]}const K=T(()=>x.value.slice().sort((s,e)=>String(s.productname||"").localeCompare(String(e.productname||""),void 0,{sensitivity:"base"}))),ne=T(()=>{if(!v.value)return K.value;const s=v.value;return K.value.filter(e=>(e.productname||"").toLowerCase().includes(s)||(e.sku||"").toLowerCase().includes(s))});async function re(){try{const s=await window.electron.invoke("get-products");x.value=Array.isArray(s)?s:[]}catch(s){console.error("fetchProducts:",s)}}async function W(){try{o.invoiceNumber=await window.electron.invoke("generate-invoice-number")}catch(s){console.error("generateInvoiceNumber:",s)}}function le(s){if(!s||!s.id)return;const e=i.value.find(a=>a.id===s.id),N=Number(s.price??s.unitPrice??s.total??0);e?(e.quantity=Number(e.quantity||0)+1,e.total=U(e.quantity*(e.unitPrice||e.price||N))):i.value.push({id:s.id,productname:s.productname||s.name||"Unnamed",quantity:1,unitPrice:N,price:N,vatSales:Number(s.vatSales||0),vatAmount:Number(s.vatAmount||0),vatExempt:Number(s.vatExempt||0),zeroRated:Number(s.zeroRated||0),total:U(N)}),_()}function oe(s){const e=i.value[s];e&&(e.quantity=Number(e.quantity||0)+1,e.total=U(e.quantity*(e.unitPrice||e.price||0)),_())}function ie(s){const e=i.value[s];e&&(e.quantity>1?(e.quantity=Number(e.quantity)-1,e.total=U(e.quantity*(e.unitPrice||e.price||0))):i.value.splice(s,1),_())}function ue(s){s>=0&&s<i.value.length&&(i.value.splice(s,1),_())}function de(){if(!n.type||n.type==="SC"||n.type==="PWD")return 0;if(n.type==="PERCENT")return Number(n.rate||0);if(n.type==="AMOUNT")return Number(n.amount||0);const s=parseFloat(n.raw);return isNaN(s)?0:s}function _(){const s=de(),e=De(i.value,n.type||"",s,w.value);r.subtotal=e.subtotal,r.vat_sales=e.vatSales,r.vat_amount=e.vatAmount,r.vat_exempt_sales=e.vatExempt,r.zero_rated_sales=e.zeroRated,r.total=e.total,r._discountAmount=e.discountAmount}M(i,_,{deep:!0}),M(()=>[n.type,n.amount,n.rate,n.raw],_),M(w,_);const X=T(()=>Math.max(0,Number(w.value)-Number(r.total||0)));T(()=>i.value.map(s=>ce(s.quantity,s.productname,s.total)));function ce(s,e,N){const a=String(s).padEnd(4," "),h=e.length>18?e.slice(0,18):e.padEnd(18," "),q=Number(N||0).toFixed(2).padStart(10," ");return`${a}${h}${q}`}const ve=T(()=>i.value.length===0),me=T(()=>!w.value||isNaN(w.value)||Number(w.value)<=0),pe=T(()=>Number(w.value)<Number(r.total)),$=T(()=>!ve.value&&!me.value&&!pe.value),be=T(()=>!$.value);function Q(){i.value=[],r.discount=0,r._discountAmount=0,n.type="",n.amount=0,n.rate=0,n.raw="",w.value=0,f.name="",f.tin="",_()}async function fe(){if(!i.value.length)return alert("No products added!");if(!$.value)return alert("Tendered amount required");try{const s={date:o.invoiceDate,customer_name:f.name||"",customer_tin:f.tin||"",vat_sales:r.vat_sales,vat_amount:r.vat_amount,vat_exempt_sales:r.vat_exempt_sales,zero_rated_sales:r.zero_rated_sales,discount:r._discountAmount||0,total:r.total,items:JSON.stringify(i.value),issued_by:o.issuedBy},e=await window.electron.invoke("add-invoice",s);alert(`Invoice saved! Number: ${e.invoice_number}`),Q(),W()}catch(s){console.error("saveInvoice:",s),alert("Failed to save invoice.")}}async function ye(){try{const s=await window.electron.invoke("check-printer-status");alert(s.connected?"âœ… Printer detected!":"âŒ Printer not detected.")}catch(s){console.error("checkPrinter:",s)}}async function ge(){if(!$.value)return alert("Cannot print: missing or invalid inputs.");if(!L.value)return alert("Receipt template not found!");try{const s=L.value.outerHTML;if(V.value)return;V.value=!0,(await window.electron.invoke("print-receipt",{html:s,openDrawer:!0})).success?(alert("ðŸ–¨ Receipt printed successfully!"),Q(),W()):alert("âŒ Print failed!")}catch(s){console.error("printReceipt:",s),alert("Printing error: "+(s&&s.message?s.message:s))}finally{V.value=!1}}we(()=>{Z(),F=Ve(Z,1e3),re(),W(),_(),u={save:async()=>{await j(800),await fe(),await D()},cancel:async()=>{await j(400),Q(),await D()},drawer:async()=>{await j(500),await te(),await D()},checkPrinter:async()=>{await j(600),await ye(),await D()},preview:async()=>{if(!$.value)return alert("Please enter tendered amount equal to or greater than total before previewing.");await j(300),m.value=!0,await D()}},window.addEventListener("footer-save",u.save),window.addEventListener("footer-cancel",u.cancel),window.addEventListener("footer-open-drawer",u.drawer),window.addEventListener("footer-check-printer",u.checkPrinter),window.addEventListener("footer-preview-receipt",u.preview)}),ke(()=>{clearInterval(F),C&&clearTimeout(C),A&&clearTimeout(A),u.save&&window.removeEventListener("footer-save",u.save),u.cancel&&window.removeEventListener("footer-cancel",u.cancel),u.drawer&&window.removeEventListener("footer-open-drawer",u.drawer),u.checkPrinter&&window.removeEventListener("footer-check-printer",u.checkPrinter),u.preview&&window.removeEventListener("footer-preview-receipt",u.preview)}),S({progress:y,startProgress:j,finishProgress:D});const xe=[{label:"Invoice Number",key:"invoiceNumber"},{label:"Issued By",key:"issuedBy"},{label:"Date",key:"invoiceDate"},{label:"Time",key:"invoiceTime"}];return(s,e)=>{const N=Se("router-link");return c(),d(R,null,[y.active?(c(),d("div",$e,[t("div",{class:"h-full bg-sky-500 dark:bg-sky-400 transition-all",style:he({width:y.value+"%"})},null,4)])):E("",!0),t("div",ze,[t("div",Me,[(c(),d(R,null,B(xe,a=>J(Le,{key:a.key,label:a.label,modelValue:o[a.key],"onUpdate:modelValue":h=>o[a.key]=h,readonly:"",class:"dark:bg-slate-800 border-gray-400 dark:text-slate-100"},null,8,["label","modelValue","onUpdate:modelValue"])),64))]),t("div",Be,[t("div",Fe,[H(t("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=a=>p.value=a),placeholder:"Search products...",class:"mb-3 w-full px-3 py-2 rounded-lg border border-gray-400 bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-sky-400"},null,512),[[G,p.value]]),t("div",Ue,[(c(!0),d(R,null,B(ne.value,a=>(c(),d("button",{key:a.id,onClick:h=>le(a),class:"w-full flex justify-between items-center px-3 py-3 text-left hover:bg-sky-200 dark:hover:bg-sky-600 transition"},[t("div",He,[t("span",We,l(a.productname),1)])],8,Oe))),128))])]),t("div",Qe,[e[7]||(e[7]=_e('<div class="border-b pb-2 mb-2"><div class="grid grid-cols-4 text-sm font-semibold text-slate-700 dark:text-slate-200"><span>Product</span><span class="text-center">Qty</span><span class="text-right">Price</span><span class="text-center">Action</span></div></div>',1)),t("div",Ge,[(c(!0),d(R,null,B(i.value,(a,h)=>(c(),d("div",{key:a.id,class:"grid grid-cols-4 items-center text-sm py-2 border-b hover:bg-slate-50 dark:hover:bg-slate-800 transition"},[t("span",Je,l(a.productname),1),t("span",Ze,l(a.quantity),1),t("span",Ke,l(k(a.total)),1),t("div",Xe,[t("button",{onClick:q=>ie(h),class:"px-2 py-1 rounded bg-slate-200 dark:bg-slate-700"},"âˆ’",8,Ye),t("button",{onClick:q=>oe(h),class:"px-2 py-1 rounded bg-sky-400 dark:bg-sky-700"},"+",8,et),t("button",{onClick:q=>ue(h),class:"px-2 py-1 rounded bg-red-500 text-white"},"Ã—",8,tt)])]))),128))])]),t("div",st,[t("div",at,[t("div",nt,[e[8]||(e[8]=t("h2",{class:"font-semibold text-lg"},"Customer",-1)),J(N,{to:"/customer",class:"flex items-center justify-center h-9 w-9 rounded-md bg-blue-600 hover:bg-blue-700 text-white transition",title:"Register Customer"},{default:Ne(()=>[J(Ce(Ae),{class:"w-4 h-4"})]),_:1})]),t("div",rt,[H(t("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>O.value=a),placeholder:"Search customer name or TINâ€¦",class:"w-full text-sm px-3 py-2 rounded border bg-white dark:bg-slate-800 border-gray-400 text-gray-900 dark:text-gray-100"},null,512),[[G,O.value]]),I.value.length>0?(c(),d("ul",lt,[(c(!0),d(R,null,B(I.value,a=>(c(),d("li",{key:a.id,onClick:h=>ae(a),class:"p-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-slate-700 border-b"},[t("p",it,l(a.lastName)+", "+l(a.firstName)+" "+l(a.middleName),1),t("p",ut,"TIN: "+l(a.tin||"â€”"),1)],8,ot))),128))])):E("",!0)])]),t("div",dt,[t("div",ct,[e[10]||(e[10]=t("h2",{class:"font-semibold text-lg text-slate-800 dark:text-slate-100"},"Discount Type",-1)),H(t("select",{"onUpdate:modelValue":e[2]||(e[2]=a=>n.type=a),class:"px-2 py-1 rounded border text-sm bg-slate-50 dark:bg-slate-800 border-gray-400 text-gray-900 dark:text-gray-100"},[...e[9]||(e[9]=[t("option",{value:""},"None",-1),t("option",{value:"SC"},"Senior Citizen",-1),t("option",{value:"PWD"},"PWD",-1)])],512),[[Pe,n.type]])]),n.type==="SC"||n.type==="PWD"?(c(),d("div",vt)):E("",!0)]),t("div",mt,[t("div",pt,[e[11]||(e[11]=t("span",{class:"text-lg text-slate-800 dark:text-slate-100"},"TENDERED",-1)),H(t("input",{type:"number","onUpdate:modelValue":e[3]||(e[3]=a=>w.value=a),onInput:e[4]||(e[4]=a=>_()),class:"w-32 text-right border rounded px-2 py-1 bg-slate-50 dark:bg-slate-800 border-gray-400 text-gray-900 dark:text-gray-100"},null,544),[[G,w.value]])]),t("div",bt,[e[12]||(e[12]=t("span",{class:"text-slate-800 dark:text-slate-100"},"CHANGE",-1)),t("span",ft,l(k(X.value)),1)])]),t("div",yt,[e[13]||(e[13]=t("span",{class:"text-xl font-semibold text-slate-900 dark:text-slate-100"},"TOTAL",-1)),t("span",gt,l(k(r.total||0)),1)])])]),m.value?(c(),d("div",xt,[t("div",wt,[e[34]||(e[34]=t("h2",{class:"text-lg font-bold mb-3 text-center"},"Receipt Preview",-1)),t("div",null,[t("div",{ref_key:"receipt",ref:L,class:"receipt-container"},[e[27]||(e[27]=t("div",{class:"text-center mb-1"},[t("h3",null,"FELTHEA STORE"),t("p",null,"123 Sample St., Barangay, City"),t("p",null,"TIN: 123-456-789"),t("p",null,"Tel: 0912-345-6789")],-1)),e[28]||(e[28]=t("hr",null,null,-1)),t("div",kt,[e[14]||(e[14]=t("span",null,"Invoice #: ",-1)),t("span",null,l(o.invoiceNumber),1)]),t("div",ht,[e[15]||(e[15]=t("span",null,"Date: ",-1)),t("span",null,l(o.invoiceDate)+" "+l(o.invoiceTime),1)]),t("div",_t,[e[16]||(e[16]=t("span",null,"Cashier: ",-1)),t("span",null,l(o.issuedBy),1)]),f.name?(c(),d("div",Nt,[e[17]||(e[17]=t("span",null,"Customer: ",-1)),t("span",null,l(f.name),1)])):E("",!0),f.tin?(c(),d("div",Pt,[e[18]||(e[18]=t("span",null,"TIN: ",-1)),t("span",null,l(f.tin),1)])):E("",!0),e[29]||(e[29]=t("hr",null,null,-1)),(c(!0),d(R,null,B(i.value,a=>(c(),d("div",{key:a.id,class:"flex justify-between mb-1"},[t("span",null,l(a.quantity)+" x "+l(a.productname),1),t("span",null,l(Number(a.total).toFixed(2)),1)]))),128)),e[30]||(e[30]=t("hr",null,null,-1)),r._discountAmount>0?(c(),d("div",St,[e[19]||(e[19]=t("span",null,"Discount",-1)),t("span",null,"-"+l(k(r._discountAmount)),1)])):E("",!0),t("div",Ct,[e[20]||(e[20]=t("span",null,"VATable Sales",-1)),t("span",null,l(k(r.vat_sales)),1)]),t("div",Tt,[e[21]||(e[21]=t("span",null,"VAT (12%)",-1)),t("span",null,l(k(r.vat_amount)),1)]),t("div",At,[e[22]||(e[22]=t("span",null,"VAT-Exempt",-1)),t("span",null,l(k(r.vat_exempt_sales)),1)]),t("div",Et,[e[23]||(e[23]=t("span",null,"Zero-Rated",-1)),t("span",null,l(k(r.zero_rated_sales)),1)]),e[31]||(e[31]=t("hr",null,null,-1)),t("div",jt,[e[24]||(e[24]=t("span",null,"Total",-1)),t("span",null,l(k(r.total)),1)]),t("div",Dt,[e[25]||(e[25]=t("span",null,"Tendered",-1)),t("span",null,l(k(w.value)),1)]),t("div",It,[e[26]||(e[26]=t("span",null,"Change",-1)),t("span",null,l(k(X.value)),1)]),e[32]||(e[32]=t("hr",null,null,-1)),e[33]||(e[33]=t("div",{class:"text-center mt-2"},[t("p",null,"*** This serves as an official receipt ***"),t("p",null,"Thank you for your purchase!")],-1))],512)]),t("div",qt,[t("button",{onClick:e[5]||(e[5]=a=>m.value=!1),class:"w-1/2 mr-2 py-2 px-4 rounded shadow bg-red-500 hover:bg-red-600 text-slate-100"},"Cancel"),t("button",{disabled:be.value,onClick:e[6]||(e[6]=a=>{$.value&&(ge(),m.value=!1)}),class:"w-1/2 ml-2 py-2 px-4 rounded shadow bg-green-500 hover:bg-green-600 text-slate-100 disabled:opacity-40"},"Confirm",8,Rt)])])])):E("",!0)])],64)}}};export{$t as default};
